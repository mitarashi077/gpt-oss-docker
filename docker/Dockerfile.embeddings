FROM python:3.11-slim

WORKDIR /app

# システムの依存関係をインストール
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 必要なPythonパッケージをインストール
RUN pip install --no-cache-dir \
    langchain==0.1.0 \
    langchain-community==0.0.10 \
    qdrant-client==1.7.0 \
    sentence-transformers==2.2.2 \
    fastapi==0.108.0 \
    uvicorn==0.25.0 \
    pypdf2==3.0.1 \
    python-multipart==0.0.6 \
    numpy==1.24.3 \
    requests==2.31.0

# エンベディングモデルの事前ダウンロード（オフライン対応）
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2')"

# アプリケーションファイルをコピー
COPY scripts/embeddings_server.py /app/

# ポートを公開
EXPOSE 8001

# サーバー起動
CMD ["uvicorn", "embeddings_server:app", "--host", "0.0.0.0", "--port", "8001", "--reload"]